<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:mongo="http://www.springframework.org/schema/data/mongo"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/data/mongo http://www.springframework.org/schema/data/mongo/spring-mongo.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <mongo:db-factory id="mongoDbFactory" dbname="${mongo.database}" mongo-ref="mongo"/>

    <bean id="mongoTemplate" class="org.springframework.data.mongodb.core.MongoTemplate">
        <constructor-arg name="mongoDbFactory" ref="mongoDbFactory"/>
        <constructor-arg name="mongoConverter" ref="mappingConverter"/>
        <property name="readPreference" value="#{T(com.mongodb.ReadPreference).nearest()}"/>
    </bean>


    <!-- by default look for a Mongo object named 'mongo' - default name used for the converter is 'mappingConverter' -->
    <mongo:mapping-converter id="mappingConverter" base-package="by.auto.domain" >
        <mongo:custom-converters>
            <mongo:converter>
                <bean class="by.auto.persistence.repository.mongo.converters.IntervalReadConverter"/>
            </mongo:converter>
            <mongo:converter>
                <bean class="by.auto.persistence.repository.mongo.converters.IntervalWriteConverter"/>
            </mongo:converter>
            <mongo:converter>
                <bean class="by.auto.persistence.repository.mongo.converters.OAuth2AuthenticationReadConverter"/>
            </mongo:converter>
        </mongo:custom-converters>
    </mongo:mapping-converter>


    <!-- MongoDB GridFS Template -->
    <bean id="gridTemplate" class="org.springframework.data.mongodb.gridfs.GridFsTemplate">
        <constructor-arg ref="mongoDbFactory"/>
        <constructor-arg ref="mappingConverter"/>
        <constructor-arg value="${mongo.gridfs.bucket}"/>
    </bean>

    <!-- Logs MongoMappingEventS that are posted onto Spring's ApplicationContextEvent infrastructure -->
    <bean class="org.springframework.data.mongodb.core.mapping.event.LoggingEventListener"/>

    <mongo:repositories base-package="by.auto.persistence.repository.mongo"/>

    <import resource="mongo-init.xml"/>


    <beans profile="!test">
        <bean class="by.auto.persistence.repository.dependency.DependencyListener"/>
        <!-- Audit -->
        <bean class="by.auto.persistence.audit.AuditableListener"/>
    </beans>

    <beans profile="mongo-ssl">
        <mongo:mongo id="mongo" replica-set="${mongo.replicaSet}" write-concern="${mongo.writeconcern}">
            <mongo:options ssl="true" ssl-socket-factory-ref="customSslSocketFactory"/>
        </mongo:mongo>

        <bean id="customSslSocketFactory" class="javax.net.ssl.SSLSocketFactory" factory-method="getDefault" scope="singleton"/>
    </beans>
    <beans profile="!mongo-ssl">
        <mongo:mongo id="mongo" replica-set="${mongo.replicaSet}" write-concern="${mongo.writeconcern}"/>
    </beans>
</beans>